'use strict';

var chunk57AVKP4H_cjs = require('./chunk-57AVKP4H.cjs');
var reactHooksAsync = require('@chengsokdara/react-hooks-async');
var react = require('react');

var ae={apiKey:"",autoStart:!1,autoTranscribe:!0,mode:"transcriptions",nonStop:!1,removeSilence:!1,stopTimeout:5e3,streaming:!1,timeSlice:1e3,onDataAvailable:void 0,onTranscribe:void 0},ie={stop:void 0},se={blob:void 0,text:void 0},fe=M=>{let{apiKey:b,autoStart:x,autoTranscribe:U,mode:S,nonStop:B,removeSilence:q,stopTimeout:K,streaming:T,timeSlice:I,whisperConfig:u,onDataAvailable:$,onTranscribe:d}={...ae,...M};if(!b&&!d)throw new Error("apiKey is required if onTranscribe is not provided");let l=react.useRef([]),i=react.useRef(),s=react.useRef(),t=react.useRef(),a=react.useRef(),m=react.useRef(ie),[j,k]=react.useState(!1),[z,C]=react.useState(!1),[R,W]=react.useState(!1),[N,w]=react.useState(!1),[G,p]=react.useState(se);react.useEffect(()=>()=>{l.current&&(l.current=[]),i.current&&(i.current.flush(),i.current=void 0),t.current&&(t.current.destroy(),t.current=void 0),y("stop"),s.current&&(s.current.off("speaking",v),s.current.off("stopped_speaking",A)),a.current&&(a.current.getTracks().forEach(e=>e.stop()),a.current=void 0);},[]),reactHooksAsync.useEffectAsync(async()=>{x&&await E();},[x]);let J=async()=>{await E();},Q=async()=>{await Y();},V=async()=>{await H();},E=async()=>{try{if(a.current||await X(),a.current){if(!t.current){let{default:{RecordRTCPromisesHandler:r,StereoAudioRecorder:o}}=await import('recordrtc'),n={mimeType:"audio/wav",numberOfAudioChannels:1,recorderType:o,sampleRate:44100,timeSlice:T?I:void 0,type:"audio",ondataavailable:U&&T?re:void 0};t.current=new r(a.current,n);}if(!i.current){let{Mp3Encoder:r}=await import('lamejs');i.current=new r(1,44100,96);}let e=await t.current.getState();(e==="inactive"||e==="stopped")&&await t.current.startRecording(),e==="paused"&&await t.current.resumeRecording(),B&&R&&F("stop"),k(!0);}}catch{}},X=async()=>{try{if(a.current&&a.current.getTracks().forEach(e=>e.stop()),a.current=await navigator.mediaDevices.getUserMedia({audio:!0}),!s.current){let{default:e}=await import('hark');s.current=e(a.current,{interval:100,play:!1}),s.current.on("speaking",v),s.current.on("stopped_speaking",A);}}catch{}},F=e=>{m.current[e]||(m.current[e]=setTimeout(H,K));},v=()=>{C(!0),W(!0),y("stop");},A=()=>{C(!1),B&&R&&F("stop");},Y=async()=>{try{t.current&&(await t.current.getState()==="recording"&&await t.current.pauseRecording(),y("stop"),k(!1),W(!1));}catch{}},H=async()=>{try{if(t.current){let e=await t.current.getState();if((e==="recording"||e==="paused")&&await t.current.stopRecording(),Z(),y("stop"),k(!1),U)await ee();else {let r=await t.current.getBlob();p({blob:r});}await t.current.destroy(),l.current=[],i.current&&(i.current.flush(),i.current=void 0),t.current=void 0;}}catch{}},Z=()=>{s.current&&(s.current.off("speaking",v),s.current.off("stopped_speaking",A),s.current=void 0),a.current&&(a.current.getTracks().forEach(e=>e.stop()),a.current=void 0);},y=e=>{m.current[e]&&(clearTimeout(m.current[e]),m.current[e]=void 0);},ee=async()=>{try{if(i.current&&t.current&&await t.current.getState()==="stopped"){w(!0);let r=await t.current.getBlob();if(q){let{createFFmpeg:o}=await import('@ffmpeg/ffmpeg'),n=o({mainName:"main",corePath:chunk57AVKP4H_cjs.b,log:!0});n.isLoaded()||await n.load();let c=await r.arrayBuffer();n.FS("writeFile","in.wav",new Uint8Array(c)),await n.run("-i","in.wav","-acodec","libmp3lame","-b:a","96k","-ar","44100","-af",chunk57AVKP4H_cjs.c,"out.mp3");let h=n.FS("readFile","out.mp3");if(h.length<=225){n.exit(),p({blob:r}),w(!1);return}r=new Blob([h.buffer],{type:"audio/mpeg"}),n.exit();}else {let o=await r.arrayBuffer(),n=i.current.encodeBuffer(new Int16Array(o));r=new Blob([n],{type:"audio/mpeg"});}if(typeof d=="function"){let o=await d(r);p(o);}else {let o=new File([r],"speech.mp3",{type:"audio/mpeg"}),n=await D(o);p({blob:r,text:n});}w(!1);}}catch{w(!1);}},re=async e=>{try{if(T&&t.current){if($?.(e),i.current){let o=await e.arrayBuffer(),n=i.current.encodeBuffer(new Int16Array(o)),c=new Blob([n],{type:"audio/mpeg"});l.current.push(c);}if(await t.current.getState()==="recording"){let o=new Blob(l.current,{type:"audio/mpeg"});if(typeof d=="function"){let n=await d(o);n.text&&p(c=>({...c,text:n.text}));}else {let n=new File([o],"speech.mp3",{type:"audio/mpeg"}),c=await D(n);c&&p(h=>({...h,text:c}));}}}}catch{}},D=reactHooksAsync.useMemoAsync(async e=>{let r=new FormData;r.append("file",e),r.append("model","whisper-1"),S==="transcriptions"&&r.append("language",u?.language??"en"),u?.prompt&&r.append("prompt",u.prompt),u?.response_format&&r.append("response_format",u.response_format),u?.temperature&&r.append("temperature",`${u.temperature}`);let o={};o["Content-Type"]="multipart/form-data",b&&(o.Authorization=`Bearer ${b}`);let{default:n}=await import('axios');return (await n.post(chunk57AVKP4H_cjs.d+S,r,{headers:o})).data.text},[b,S,u]);return {recording:j,speaking:z,spokeAtLeastOnce:R,transcribing:N,transcript:G,pauseRecording:Q,startRecording:J,stopRecording:V}};

exports.a = fe;
